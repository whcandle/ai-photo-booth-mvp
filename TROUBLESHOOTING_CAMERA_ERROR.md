# 相机参数设置错误排查指南

## 错误码 0x00000061 分析

错误信息：`EdsGetPropertyDesc(propId=0x00000402) failed: 0x00000061`

这个错误通常表示：
- **相机会话未正确打开**
- **相机处于不支持手动设置的模式**（如全自动模式）
- **相机正在执行其他操作**（预览、拍照等）
- **相机连接不稳定**

---

## 排查步骤

### 步骤 1: 检查相机状态

**PowerShell 命令：**
```powershell
Invoke-RestMethod -Uri "http://localhost:8080/local/camera/status" -Method Get
```

**或者使用 curl.exe：**
```bash
curl.exe http://localhost:8080/local/camera/status
```

**检查要点：**
- ✅ `cameraConnected` 应该为 `true`
- ✅ `sessionOpened` 应该为 `true`
- ✅ `sdkInitialized` 应该为 `true`
- ✅ `error` 应该为 `null`

如果任何一项为 `false` 或 `null`，说明相机连接有问题。

---

### 步骤 2: 检查相机模式

**重要：** 相机必须处于支持手动设置的模式：
- ✅ **M 档**（手动模式）
- ✅ **Av 档**（光圈优先）
- ✅ **Tv 档**（快门优先）
- ✅ **P 档**（程序自动，部分参数可调）

❌ **不支持的模式：**
- ❌ **AUTO 档**（全自动模式）- 不允许手动设置参数
- ❌ **场景模式**（人像、风景等）- 不允许手动设置参数

**解决方法：**
1. 在相机上切换到 **M 档** 或 **Av 档**
2. 然后重新尝试应用 preset

---

### 步骤 3: 停止预览（如果正在运行）

如果预览正在运行，可能会占用相机资源，导致设置参数失败。

**停止预览（如果有预览接口）：**
```bash
# 如果有停止预览的接口，先调用它
# 或者重启 CameraAgent 服务
```

---

### 步骤 4: 重启 CameraAgent 服务

如果以上步骤都正常，但问题仍然存在，尝试重启 CameraAgent：

1. **停止 CameraAgent**
2. **重新启动 CameraAgent**
3. **等待相机连接完成**
4. **再次尝试应用 preset**

---

### 步骤 5: 检查相机连接

1. **检查 USB 连接**
   - 确保 USB 线连接稳定
   - 尝试重新插拔 USB 线

2. **检查相机电源**
   - 确保相机已开机
   - 确保相机电池充足

3. **检查相机是否被其他程序占用**
   - 关闭其他可能使用相机的程序（如 Canon EOS Utility）

---

## 临时解决方案

如果问题持续存在，可以尝试：

### 方案 1: 先应用 preset，再单独设置参数

```bash
# 1. 先应用 preset（可能会失败，但至少会更新 camera.json）
curl -X POST http://localhost:8080/local/camera/presets/apply -H "Content-Type: application/json" -d "{\"presetId\":\"preset_night_indoor\"}"

# 2. 然后单独设置参数（跳过验证）
# 注意：这需要修改代码，暂时禁用参数验证
```

### 方案 2: 直接修改 camera.json，不通过 API

1. 直接编辑 `camera.json`，修改 preset 参数
2. 重启 MVP
3. 应用 preset 时，如果参数转换失败，至少 `camera.json` 已经更新

---

## 常见错误码对照

| 错误码 | 含义 | 解决方法 |
|--------|------|----------|
| `0x00000061` | 设备忙/会话错误 | 检查相机模式、重启服务 |
| `0x00000081` | 设备忙 | 等待相机完成当前操作 |
| `0x0000A102` | 对象未就绪 | 检查相机连接 |

---

## 建议的修复流程

1. ✅ **检查相机状态** → 确认连接正常
2. ✅ **切换到 M 档** → 确保支持手动设置
3. ✅ **重启 CameraAgent** → 重新建立会话
4. ✅ **再次尝试应用 preset** → 应该可以成功

---

## 如果问题仍然存在

请提供以下信息：
1. 相机状态 API 的完整响应
2. 相机型号和当前模式
3. CameraAgent 的日志（特别是错误信息）
4. 是否正在运行预览或其他操作
